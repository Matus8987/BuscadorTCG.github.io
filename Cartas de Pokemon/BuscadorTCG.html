<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buscador Pokémon TCG</title>
  <!-- Bootstrap CSS para barra de progreso -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link href="https://fonts.cdnfonts.com/css/pokemon-solid" rel="stylesheet">
  <link rel="stylesheet" href="BuscadorTCG.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#" data-translate="nav.brand">Pokémon TCG</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link " style="color: white;" aria-current="page" href="../Perfil Usuario/perfil.html" data-translate="nav.home">Inicio</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" style="color: white;" href="../Cartas de Pokemon/BuscadorTCG.html" data-translate="nav.cards">Cartas</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" style="color: white;" href="../Paquetes/Paquetes.html" data-translate="nav.packs">Paquetes</a>
          </li>
        </ul>
        <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
          <!-- Dropdown de idiomas -->
          <div class="nav-item dropdown me-3">
            <a id="languageDropdownToggle" class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: white;">
              <i class="bi bi-translate"></i>
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="changeLanguage('es')">Español</a></li>
              <li><a class="dropdown-item" href="#" onclick="changeLanguage('en')">English</a></li>
            </ul>
          </div>
          <!-- Barra de usuario integrada en navbar -->
          <div id="userBar" class="navbar-nav" style="display: none;">
            <div class="nav-item d-flex align-items-center">
              <span id="currentUserName" class="nav-link text-dark fw-semibold me-2" style="color: white !important;"></span>
              <i class="bi bi-box-arrow-right nav-link" onclick="logout()" style="cursor: pointer; font-size: 18px; color: white;" title="Cerrar sesión"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Contenedor principal de la pagina-->
  <div class="page-wrapper">
    <header>
      <h1 data-translate="cards.title">Buscador de Cartas Pokémon TCG</h1>
    </header>
    <main>
      <!-- Formulario para buscar cartas por nombre o número -->
      <form id="search-form" novalidate>
        <input
          type="text"
          id="search-input"
          data-translate-placeholder="cards.search.placeholder"
          placeholder="Nombre o Número Pokédex"
          aria-label="Buscar cartas Pokémon por nombre o número"
          autocomplete="off"
          required
        />
        <button type="submit" data-translate="cards.search.button">Buscar</button>
        <button type="button" id="clear-search" data-translate="cards.search.clear" title="Limpiar búsqueda">Limpiar Búsqueda</button>
      </form>
      
      <!-- Barra de progreso mejorada -->
      <div id="loading-container" style="text-align:center; margin: 20px 0; display: none;">
        <div id="loading-message" style="color: white; font-weight: 600; margin-bottom: 10px;" data-translate="cards.loading">Cargando cartas...</div>
        <div class="progress" role="progressbar" aria-label="Progreso de carga de cartas" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 25px; max-width: 400px; margin: 0 auto; background-color: rgba(255,255,255,0.3); border-radius: 12px; overflow: hidden;">
          <div id="loading-progress-bar" class="progress-bar" style="width: 0%; background: linear-gradient(90deg, #6d3704, #ffa807); color: white; font-weight: 600; line-height: 25px; text-align: center; transition: width 0.5s ease-in-out;">0%</div>
        </div>
      </div>

      <!-- Controles de filtrado -->
      <div id="filter-controls" style="display: none; text-align: center; margin-bottom: 20px;">
        <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
          <div>
            <label for="rarity-filter" style="color: white; font-weight: 700; margin-right: 5px;" data-translate="cards.filter.rarity">Rareza:</label>
            <select id="rarity-filter">
              <option value="" data-translate="cards.filter.all">Todas</option>
            </select>
          </div>
          <div>
            <label for="set-filter" style="color: white; font-weight: 700; margin-right: 5px;" data-translate="cards.filter.set">Set:</label>
            <select id="set-filter">
              <option value="" data-translate="cards.filter.all">Todos</option>
            </select>
          </div>
          <button id="clear-filters" type="button" style="padding: 5px 10px; font-size: 0.9rem;" data-translate="cards.filter.clear">Limpiar Filtros</button>
        </div>
      </div>

      <!-- Contenedor donde se mostrarán las cartas -->
      <section id="cards-container" aria-live="polite" aria-atomic="true">
      </section>

      <!-- Información de resultados -->
      <div style="text-align: center; margin-top: 20px;">
        <span id="results-info" class="paginacion" style="display: none;"></span>
      </div>
    </main>
  </div>

  <!-- Modal para mostrar detalles de la carta -->
  <div
    id="card-modal"
    class="modal"
    aria-hidden="true"
    role="dialog"
    aria-labelledby="card-modal-title"
    aria-modal="true"
  >
    <div class="modal-content">
      <i class="bi bi-star"></i>
      <button id="card-modal-close" aria-label="Cerrar modal">&times;</button>
      <h2 id="card-modal-title"></h2>
      <img id="card-modal-image" src="" alt="" />
      <p><strong data-translate="cards.modal.type">Tipo:</strong> <span id="card-modal-type"></span></p>
      <p><strong data-translate="cards.modal.rarity">Rareza:</strong> <span id="card-modal-rarity"></span></p>
      <p><strong data-translate="cards.modal.set">Set:</strong> <span id="card-modal-set"></span></p>
      <p>
        <strong data-translate="cards.modal.info">Información adicional:</strong> <span id="card-modal-info"></span>
      </p>
    </div>
  </div>

  <!-- Modal para mostrar errores -->
  <div
    id="error-modal"
    class="modal"
    aria-hidden="true"
    role="alertdialog"
    aria-modal="true"
    aria-labelledby="error-modal-title"
    aria-describedby="error-modal-message"
  >
    <div class="modal-content error-content">
      <button id="error-modal-close" aria-label="Cerrar modal de error">&times;</button>
      <h2 id="error-modal-title" data-translate="cards.error.title">Error</h2>
      <p id="error-modal-message"></p>
    </div>
  </div>

  <!-- Modal: seleccionar paquete a donde agregar la carta -->
  <div id="package-select-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="package-select-title">
    <div class="modal-content package-select">
      <header class="modal-header">
        <h3 id="package-select-title" data-translate="cards.package.title">Selecciona un paquete</h3>
        <button class="btn-close" aria-label="Cerrar" onclick="closeModal(document.getElementById('package-select-modal'))"></button>
      </header>
      <div id="package-list" class="package-list" role="list"></div>
      <footer class="modal-footer small-note" style="display:block; text-align:center;">
        <small data-translate="cards.package.note">Si no hay paquetes, crea uno en la sección "Paquetes".</small>
      </footer>
    </div>
  </div>
  
  <!-- Modal: confirmación de guardado -->
  <div id="confirm-save-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="confirm-save-title">
    <div class="modal-content confirm-save">
      <div class="confirm-icon" aria-hidden="true">✓</div>
      <h2 id="confirm-save-title" data-translate="cards.save.title">¡Guardada!</h2>
      <p id="confirm-save-body" data-translate="cards.save.message">La carta se ha añadido al paquete correctamente.</p>
    </div>
  </div>

  <!-- Contenedor para clones animados (se usa desde JS) -->
  <div id="animation-overlay" aria-hidden="true" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:2000;"></div>

  <script src="BuscadorTCG.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  
  <!-- Script de traducción cargado después de Bootstrap -->
  <script>
  // Cargar el traductor dinámicamente para evitar conflictos
  function loadTranslator() {
      return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = '../Traduccion/translator.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
      });
  }

  // Inicializar después de cargar todo
  document.addEventListener('DOMContentLoaded', function() {
      loadTranslator().then(() => {
          setTimeout(() => {
              if (typeof changeLanguage === 'function') {
                  const savedLanguage = localStorage.getItem('selectedLanguage') || 'es';
                  updateTranslations(savedLanguage);
                  console.log('Translator loaded and initialized');
              }
          }, 200);
      }).catch(error => {
          console.error('Error loading translator:', error);
      });
  });

  // --- Fallback ligero para el dropdown de idiomas ---
  // Añade soporte para abrir/cerrar el menú si Bootstrap no inicializa correctamente el componente.
  (function() {
    function qs(sel, ctx) { return (ctx || document).querySelector(sel); }
    function qsa(sel, ctx) { return Array.from((ctx || document).querySelectorAll(sel)); }

    document.addEventListener('click', function(e) {
      const toggle = qs('#languageDropdownToggle');
      if (!toggle) return;

      const menu = toggle.nextElementSibling && toggle.nextElementSibling.classList.contains('dropdown-menu')
        ? toggle.nextElementSibling
        : null;

      // Si se hizo click sobre el toggle, alternar el menú
      if (e.target.closest && e.target.closest('#languageDropdownToggle')) {
        // Preferir el comportamiento nativo de Bootstrap si está presente (no romper)
        const bsDropdown = toggle.__dropdownInstance || null;
        if (bsDropdown) {
          // Si Bootstrap está activo, dejar que gestione el toggle
          return;
        }
        // fallback: toggle visual
        const isShown = menu && menu.classList.contains('show');
        if (menu) {
          menu.classList.toggle('show', !isShown);
          toggle.setAttribute('aria-expanded', String(!isShown));
        }
        e.preventDefault();
        return;
      }

      // Si se hizo click fuera del menú y del toggle, cerrar el menú
      if (menu && menu.classList.contains('show') && !e.target.closest('.dropdown')) {
        menu.classList.remove('show');
        toggle.setAttribute('aria-expanded', 'false');
      }
    });

    // Opcional: cerrar el menú con Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const toggle = qs('#languageDropdownToggle');
        const menu = toggle && toggle.nextElementSibling && toggle.nextElementSibling.classList.contains('dropdown-menu')
          ? toggle.nextElementSibling
          : null;
        if (menu && menu.classList.contains('show')) {
          menu.classList.remove('show');
          toggle.setAttribute('aria-expanded', 'false');
        }
      }
    });
  })();
  </script>
</body>
</html>